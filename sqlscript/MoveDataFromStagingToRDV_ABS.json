{
	"name": "MoveDataFromStagingToRDV_ABS",
	"properties": {
		"content": {
			"query": "-- DROP PROCEDURE [ext].[load_from_parquet_to_rdv]\n\nCREATE PROCEDURE [ext].[load_from_parquet_to_rdv]\n    @file_path varchar(50),\n    @file_name varchar(50),\n\t@gdp_pipeline_id varchar(50)\n \nAS\nBEGIN\n    -- Start Transaction\n    -- BEGIN TRANSACTION\n\n    -- BEGIN TRY\n        -- Define and set variables\n        DECLARE @create_ext_table nvarchar(4000)\n\t\tDECLARE @insert_h_financial_transaction nvarchar(4000)\n\n        DECLARE @ext_table_name VARCHAR(150)\n\t\tDECLARE @drop_ext_table nvarchar(4000)\n\n\t\tDECLARE @gdp_load_ts        datetime2(0)\n\t\tDECLARE @gdp_src_sys_id\t\tint\n\t\tDECLARE @gdp_oe_id\t\t\tint\n\t\tDECLARE @gdp_uiss\t\t\tvarchar(50)\n\t\tDECLARE @gdp_src_desc       varchar(50)\n\t\t \n\t\tSET @gdp_load_ts            = GETDATE()\n\t\tSET @gdp_src_sys_id\t\t\t= 710\n\t\tSET @gdp_oe_id \t\t\t\t= CONVERT(int, SUBSTRING(@file_path, 0, charindex('@', @file_path, 0)))\n\t\t-- SET @gdp_oe_id \t\t\t\t= '710'\n\t\tSET @gdp_uiss\t\t\t\t= ''\n\t\tSET @gdp_src_desc          \t= 'ABS'\n\t\t\n        -- Generate unique external table name. \n        SELECT @ext_table_name = 'ext.'+ @file_name\n\n        -- Create external table\n        SET @create_ext_table = '\n        CREATE EXTERNAL TABLE ' + @ext_table_name + ' (\n            \t[fs_mandt] nvarchar(4000),\n\t\t\t\t[fs_bukrs] nvarchar(4000),\n\t\t\t\t[fs_ic_bukrs] nvarchar(4000),\n\t\t\t\t[pfs_id] nvarchar(4000),\n\t\t\t\t[budat_str] nvarchar(4000),\n\t\t\t\t[buper] nvarchar(4000),\n\t\t\t\t[beldat_str] nvarchar(4000),\n\t\t\t\t[bec_erkennung1] nvarchar(4000),\n\t\t\t\t[bec_erkennung2] nvarchar(4000),\n\t\t\t\t[bec_erkennung3] nvarchar(4000),\n\t\t\t\t[bec_erkennung4] nvarchar(4000),\n\t\t\t\t[bec_erkennung5] nvarchar(4000),\n\t\t\t\t[bec_erkennung6] nvarchar(4000),\n\t\t\t\t[bec_erkennung7] nvarchar(4000),\n\t\t\t\t[bec_erkennung8] nvarchar(4000),\n\t\t\t\t[bec_erkennung9] nvarchar(4000),\n\t\t\t\t[bec_erkennung10] nvarchar(4000),\n\t\t\t\t[fs_bschl] nvarchar(4000),\n\t\t\t\t[fs_sitem] nvarchar(4000),\n\t\t\t\t[fs_ldgrp1] nvarchar(4000),\n\t\t\t\t[fs_ldgrp2] nvarchar(4000),\n\t\t\t\t[fs_sub_acct] nvarchar(4000),\n\t\t\t\t[fs_kostl] nvarchar(4000),\n\t\t\t\t[aufnr] nvarchar(4000),\n\t\t\t\t[fs_vbund1] nvarchar(4000),\n\t\t\t\t[fs_vbund2] nvarchar(4000),\n\t\t\t\t[fs_lkz] nvarchar(4000),\n\t\t\t\t[fs_segment] nvarchar(4000),\n\t\t\t\t[fmk1] nvarchar(4000),\n\t\t\t\t[fmk2] nvarchar(4000),\n\t\t\t\t[prodschl] nvarchar(4000),\n\t\t\t\t[vmk] nvarchar(4000),\n\t\t\t\t[khd] nvarchar(4000),\n\t\t\t\t[fkz] nvarchar(4000),\n\t\t\t\t[prg] nvarchar(4000),\n\t\t\t\t[dch] nvarchar(4000),\n\t\t\t\t[may] nvarchar(4000),\n\t\t\t\t[csg] nvarchar(4000),\n\t\t\t\t[bktxt] nvarchar(4000),\n\t\t\t\t[sgtxt] nvarchar(4000),\n\t\t\t\t[fs_zuonr] nvarchar(4000),\n\t\t\t\t[hwbtrg_str] nvarchar(4000),\n\t\t\t\t[twbtrg_str] nvarchar(4000),\n\t\t\t\t[fs_waers] nvarchar(4000),\n\t\t\t\t[fs_mwskz] nvarchar(4000),\n\t\t\t\t[seinz] nvarchar(4000),\n\t\t\t\t[in_stat] nvarchar(4000),\n\t\t\t\t[fs_blnr1] nvarchar(4000),\n\t\t\t\t[vsnr] nvarchar(4000),\n\t\t\t\t[vtnr] nvarchar(4000),\n\t\t\t\t[vunr] nvarchar(4000),\n\t\t\t\t[zubringer] nvarchar(4000),\n\t\t\t\t[vorvnr] nvarchar(4000),\n\t\t\t\t[vart] nvarchar(4000),\n\t\t\t\t[gsa] nvarchar(4000),\n\t\t\t\t[gsakat] nvarchar(4000),\n\t\t\t\t[tarif] nvarchar(4000),\n\t\t\t\t[bnrb] nvarchar(4000),\n\t\t\t\t[basisbetrag_str] nvarchar(4000),\n\t\t\t\t[schadenom] nvarchar(4000),\n\t\t\t\t[kundennr] nvarchar(4000),\n\t\t\t\t[zjahr] nvarchar(4000),\n\t\t\t\t[inkassoart] nvarchar(4000),\n\t\t\t\t[betragsart] nvarchar(4000),\n\t\t\t\t[bubsz] nvarchar(4000),\n\t\t\t\t[sdartgrp] nvarchar(4000),\n\t\t\t\t[azj] nvarchar(4000),\n\t\t\t\t[azp] nvarchar(4000),\n\t\t\t\t[aj] nvarchar(4000),\n\t\t\t\t[schdjahr] nvarchar(4000),\n\t\t\t\t[bgzn] nvarchar(4000),\n\t\t\t\t[snr] nvarchar(4000),\n\t\t\t\t[vertrag_firma] nvarchar(4000),\n\t\t\t\t[werbernr] nvarchar(4000),\n\t\t\t\t[be_alloc] nvarchar(4000),\n\t\t\t\t[ic_fmk1] nvarchar(4000),\n\t\t\t\t[reconcil_1] nvarchar(4000),\n\t\t\t\t[vt_azp_original] nvarchar(4000),\n\t\t\t\t[lzbkz] nvarchar(4000),\n\t\t\t\t[fs_blnr2] nvarchar(4000),\n\t\t\t\t[reconcil_2] nvarchar(4000),\n\t\t\t\t[fs_hwaers] nvarchar(4000),\n\t\t\t\t[hsp_eigen] nvarchar(4000),\n\t\t\t\t[sartkbez] nvarchar(4000),\n\t\t\t\t[om_vors] nvarchar(4000),\n\t\t\t\t[steuerprozent_str] nvarchar(4000),\n\t\t\t\t[rvnr] nvarchar(4000),\n\t\t\t\t[lart] nvarchar(4000),\n\t\t\t\t[hbsnr] nvarchar(4000),\n\t\t\t\t[kzvertriebsweg] nvarchar(4000),\n\t\t\t\t[bervon] nvarchar(4000),\n\t\t\t\t[berbis] nvarchar(4000),\n\t\t\t\t[financial_transaction_bus_id] nvarchar(4000)\n        ) WITH (DATA_SOURCE = [StagingParquetSource], LOCATION ='+ @file_path + ', FILE_FORMAT = [StagingParquetFormat], REJECT_TYPE = VALUE, REJECT_VALUE = 0);'\n\n\t\t-- SET variable for dropping the external table\n\t\tSET @drop_ext_table = 'DROP EXTERNAL TABLE ' + @ext_table_name + ';'\n\n\t\t-- exeucte create external table sql code\n        EXECUTE sp_executesql @create_ext_table;\n\t\t\n\t\t-- Insert data into \\\"h_financial_transaction\\\" table from external table\n        INSERT INTO [rdv].[h_financial_transaction]\n            SELECT\n                CONVERT(varchar(255), HASHBYTES('MD5', financial_transaction_bus_id)) AS hk,\n                GETDATE() AS gdp_load_ts,\n                710 AS gdp_src_sys_id,\n                710 AS gdp_oe_id,\n                '' AS gdp_uiss,\n                '' AS gdp_pipeline_id,\n\t\t\t\t'' AS gdp_src_desc,\n                financial_transaction_bus_id AS financial_transaction_bus_id\n            FROM  ext.ABS_20220226_03834\n             WHERE NOT EXISTS (\n                SELECT [hk]\n                FROM [rdv].[h_financial_transaction]\n                WHERE hk = hk\n            )\n\n\n\t\t-- Insert data into \\\"s_financial_transaction\\\" table from external table\n        INSERT INTO [rdv].[s_financial_transaction]\n                        SELECT\n                CONVERT(varchar(255), HASHBYTES('MD5', financial_transaction_bus_id)) AS hk,\n\t\t\t\tGETDATE() AS gdp_load_ts,\n\t\t\t\tNULL AS gdp_invalid_ts,\n\t\t\t\t710 AS gdp_src_sys_id,\n\t\t\t\t710 AS gdp_oe_id,\n\t\t\t\tNULL AS gdp_pipeline_id,\n\t\t\t\tNULL AS gdp_src_desc,\n\t\t\t\tNULL AS gdp_uiss,\n\t\t\t\tNULL AS gdp_hashdiff,\n\t\t\t\tNULL AS invld_flg,\n\t\t\t\tNULL AS oe_tech_vld_from_ts,\n\t\t\t\tNULL AS bus_eff_from_ts,\n\t\t\t\tfs_mandt AS fdr_sys_tnnt_nm,\n\t\t\t\tfs_bukrs AS fdr_sys_bkd_area_nm,\n\t\t\t\tCONVERT(datetime2, budat_str, 102) AS bkd_dt_ts,\n                buper AS bkd_prd,\n\t\t\t\tCONVERT(date, beldat_str, 112) AS vchr_dt,\n\t\t\t\tfs_ldgrp1 AS fdr_sys_ldgr_group_1_nm,\n\t\t\t\tfs_zuonr AS fdr_sys_allctn_no_txt,\n\t\t\t\tCONVERT(numeric(18,2), replace(hwbtrg_str, ',', '.')) AS grp_dmstc_curr_amt,\n\t\t\t\tNULL AS grp_dmstc_curr_orig_amt,\n\t\t\t\tCONVERT(numeric(18,2), replace(twbtrg_str, ',', '.')) AS trans_curr_amt,\n\t\t\t\tNULL AS trans_curr_orig_amt,\n\t\t\t\tfs_waers AS fdr_sys_curr_cd,\n\t\t\t\tfs_blnr1 AS fdr_sys_vchr_no_ref_1_cd,\n\t\t\t\tNULL AS vchr_no_ref_fnctnl_txt,\n\t\t\t\tNULL AS bkd_cntr_nm,\n\t\t\t\tNULL AS vat_cd,\n\t\t\t\tNULL AS fdr_sys_id,\n\t\t\t\tpfs_id AS pre_fdr_sys_id,\n\t\t\t\tfs_hwaers AS curr_key_first_lcl_curr_cd,\n\t\t\t\tfs_ldgrp2 AS fdr_sys_ldgr_group_2_nm\n\n            FROM ext.ABS_20220226_03834\n            WHERE NOT EXISTS (\n                SELECT [hk]\n                FROM [rdv].[s_financial_transaction]\n                WHERE hk = hk\n            )\n\t\t\t\n\t\t-- execute drop the external table\n\t\tEXECUTE sp_executesql @drop_ext_table\n\n        -- Commit Transaction\n        -- COMMIT TRANSACTION\n    -- END TRY\n    -- BEGIN CATCH\n    --     -- Rollback Transaction\n    --     ROLLBACK TRANSACTION\n    -- END CATCH\nEND",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "Pool1",
				"poolName": "Pool1"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
